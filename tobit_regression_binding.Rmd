---
title: "Fit Tobit regression to per-barcode binding measurements"
author: "Tyler Starr"
date: "5/6/2020"
output:
  github_document:
    html_preview: false
editor_options: 
  chunk_output_type: inline
---

This notebook takes the per-barcode measurements of -log10(*K*<sub>D,app</sub>), and fits a censored regression (Tobit regression) model to deconvolve single mutant effect coefficients.

```{r setup, message=FALSE, warning=FALSE, error=FALSE}
require("knitr")
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(dev.args = list(png = list(type = "cairo")))

#list of packages to install/load
packages = c("data.table","tidyverse","VGAM","censReg")
#install any packages not already installed
installed_packages <- packages %in% rownames(installed.packages())
if(any(installed_packages == F)){
  install.packages(packages[!installed_packages])
}
#load packages
invisible(lapply(packages, library, character.only=T))

#read in config file
config <- read_yaml("config.yaml")

#read in file giving concordance between RBD numbering and SARS-CoV-2 Spike numbering
RBD_sites <- read.csv(file="data/RBD_sites.csv",stringsAsFactors=F)

#make output directory
if(!file.exists(config$tobit_regression_binding_dir)){
 dir.create(file.path(config$tobit_regression_binding_dir))
}
```
Session info for reproducing environment:
```{r print_sessionInfo}
sessionInfo()
```

## Setup

Read in per-barcode measurements of -log10(*K*<sub>D,app</sub>) (also called log10(*K*<sub>A,app</sub>)).

```{r read_input}
dt <- data.table(read.csv(file=config$Titeseq_Kds_file,stringsAsFactors = F)) #later on, could imagine also loading in other targets and having these as additional factors int the tobit regression?
```

## Deconvolving single-mutant effects on binding using censored linear regressions

Our -log10(*K*<sub>D,app</sub>) scale is additive, meaning the effect of a double mutant as change in -log10(*K*<sub>D,app</sub>) is expressed as the sum of the two component single mutational effects on -log10(*K*<sub>D,app</sub>). The exception to this is that we have known, harsh censoring of our measurements at the boundary condition of 10<sup>-6</sup>M (we could also consider an upper boundary of 10<sup>-13</sup>M, as we still have the 0M point, plus we didn't end up having any variants with binding at this boundary condition anyway) imposed by our concentration range in the assay. (The validity of this additive linear range, apart from range censoring, is supported from our initial attempts to fit an Otwinowski et al. style global epistasis model to these data, which essentially fit strong censoring at the lower boundary, and a more-or less linear response through the dynamic range of our assay.) We will therefore use this knowledge of the underlying nonlinearity to motivate the use of *censored linear regression* models to decompose single mutant effects from our barcode-level measurements.

```{r setup_model_matrix}
#split concatenated aa_substitutions, which will become our model factors
dt[,aa_subs_list := list(strsplit(aa_substitutions,split=" ")),by=(barcode)]

#split into dt for each library to avoid undetermined mutations from one library becoming undetermined values in the other; censor for complete observations
dt_1 <- dt[library=="lib1" & !is.na(log10Ka),]
dt_2 <- dt[library=="lib2" & !is.na(log10Ka),]

#make model matrix type data frame, where each column is a mutation, and each row is a barcode measurement. Cells are 1 if a barcode has the mutation given in the column, 0 if a barcode does not have the mutation. It is therefore quite a sparse matrix.
levels_1 <- levels(factor(unlist(dt_1[,aa_subs_list])))
matrix_1 <- as.matrix(do.call(rbind, lapply(lapply(dt_1[,aa_subs_list], factor, levels_1), table)))

levels_2 <- levels(factor(unlist(dt_2[,aa_subs_list])))
matrix_2 <- as.matrix(do.call(rbind, lapply(lapply(dt_2[,aa_subs_list], factor, levels_2), table)))

#check that the number of mutations in each barcode as the matrix rowSum matches the number of mutations annotated in the dt table
stopifnot(rowSums(matrix_1)==dt_1$n_aa_substitutions)
stopifnot(rowSums(matrix_2)==dt_2$n_aa_substitutions)

# tobit_1 <- censReg(dt_1$log10Ka ~ matrix_1, left=6)
# save(tobit_1,file=paste(config$tobit_regression_binding_dir,"/tobit_1.Rda",sep=""))
tobit_2 <- censReg(dt_2$log10Ka ~ matrix_2, left=6)
save(tobit_2,file=paste(config$tobit_regression_binding_dir,"/tobit_2.Rda",sep=""))

```


```{r example_plot, fig.width=4,fig.height=4,fig.align="center", dpi=300,dev="png"}

```



